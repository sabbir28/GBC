name: Android Enterprise Release

on:
  push:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11
          cache: gradle

      - name: Validate changelog
        run: |
          git diff HEAD~1 --name-only | grep CHANGELOG.md || exit 1

      - name: Load version
        id: version
        run: |
          VERSION_NAME=$(grep VERSION_NAME version.properties | cut -d= -f2)
          VERSION_CODE=$(grep VERSION_CODE version.properties | cut -d= -f2)
          echo "name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "code=$VERSION_CODE" >> $GITHUB_OUTPUT

      - name: Increment versionCode
        run: |
          sed -i "s/VERSION_CODE=${{ steps.version.outputs.code }}/VERSION_CODE=$((${{ steps.version.outputs.code }} + 1))/" version.properties
          git commit -am "ci: bump versionCode"
          git push

      - name: Grant gradle permission
        run: chmod +x gradlew

      - name: Build APKs
        run: ./gradlew assembleProdRelease bundleProdRelease

      - name: Create Git tag
        run: |
          TAG=v${{ steps.version.outputs.name }}
          git tag $TAG
          git push origin $TAG

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.name }}
          name: Release v${{ steps.version.outputs.name }}
          generate_release_notes: true
          files: |
            app/build/outputs/apk/prod/release/*.apk
            app/build/outputs/bundle/prodRelease/*.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON }}
          packageName: sabbir.apk
          releaseFiles: app/build/outputs/bundle/prodRelease/*.aab
          track: production
          status: completed
